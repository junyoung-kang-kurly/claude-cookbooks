name: Sync Main to Develop

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  sync-to-develop:
    # mainì— PRì´ ë¨¸ì§€ëœ ê²½ìš° ì‹¤í–‰
    if: github.event.pull_request.merged == true

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ ë¨¸ì§€ ì‘ì—… ìˆ˜í–‰
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest branches
        run: |
          git fetch origin main
          git fetch origin develop

      - name: Attempt to merge main into develop
        id: merge
        continue-on-error: true
        run: |
          git checkout develop
          git merge origin/main --no-edit
          echo "merge_result=$?" >> $GITHUB_OUTPUT

      - name: Push to develop if no conflicts
        if: steps.merge.outcome == 'success'
        run: |
          git push origin develop
          echo "âœ… Successfully merged main into develop automatically"

      - name: Create sync branch if conflicts exist
        if: steps.merge.outcome == 'failure'
        id: create_branch
        run: |
          # ì¶©ëŒ ë°œìƒ ì‹œ ë¨¸ì§€ ì¤‘ë‹¨
          git merge --abort || true

          # íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ê³ ìœ í•œ ë¸Œëœì¹˜ëª… ìƒì„±
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SYNC_BRANCH="sync/main-to-develop-${TIMESTAMP}"
          echo "sync_branch=${SYNC_BRANCH}" >> $GITHUB_OUTPUT

          # develop ë² ì´ìŠ¤ë¡œ ìƒˆ ë¸Œëœì¹˜ ìƒì„±
          git checkout -b ${SYNC_BRANCH}

          # mainì„ ë¨¸ì§€ ì‹œë„ (ì¶©ëŒ ìƒíƒœ ìœ ì§€)
          git merge origin/main --no-commit || true

          # ì¶©ëŒ íŒŒì¼ ëª©ë¡ ìˆ˜ì§‘
          CONFLICT_FILES=$(git diff --name-only --diff-filter=U | sed 's/^/- /' || echo "- (íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")
          echo "conflict_files<<EOF" >> $GITHUB_OUTPUT
          echo "${CONFLICT_FILES}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ì¶©ëŒ ìƒíƒœ ê·¸ëŒ€ë¡œ ì»¤ë°‹ (ë‚˜ì¤‘ì— ìˆ˜ë™ í•´ê²°)
          git add .
          git commit -m "Merge main into develop (conflicts exist)" || true

          # ë¸Œëœì¹˜ í‘¸ì‹œ
          git push origin ${SYNC_BRANCH}

      - name: Create Pull Request for manual conflict resolution
        if: steps.merge.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          MERGED_BY="${{ github.event.pull_request.user.login }}"
          SYNC_BRANCH="${{ steps.create_branch.outputs.sync_branch }}"
          CONFLICT_FILES="${{ steps.create_branch.outputs.conflict_files }}"

          # PR ë³¸ë¬¸ ìƒì„±
          PR_BODY=$(cat <<EOF
          ## ğŸ”„ ìë™ ë™ê¸°í™” PR

          ì´ PRì€ Main ë¸Œëœì¹˜ë¥¼ Developì— ë™ê¸°í™”í•˜ê¸° ìœ„í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

          ### ì›ë³¸ ì •ë³´
          - **ë¨¸ì§€ëœ ë¸Œëœì¹˜**: \`${SOURCE_BRANCH}\`
          - **ë¨¸ì§€ ì»¤ë°‹**: \`${MERGE_COMMIT}\`
          - **ë¨¸ì§€í•œ ì‚¬ëŒ**: @${MERGED_BY}

          ### âš ï¸ ì¶©ëŒ ë°œìƒ

          ë‹¤ìŒ íŒŒì¼ì—ì„œ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤:
          ${CONFLICT_FILES}

          ### í•´ê²° ë°©ë²•

          1. ë¡œì»¬ì—ì„œ ì´ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ:
             \`\`\`bash
             git fetch origin
             git checkout ${SYNC_BRANCH}
             \`\`\`

          2. ì¶©ëŒ ìˆ˜ë™ í•´ê²°:
             \`\`\`bash
             # ì¶©ëŒ íŒŒì¼ í™•ì¸
             git status

             # IDE ë˜ëŠ” ì—ë””í„°ë¡œ ì¶©ëŒ í•´ê²°
             # <<<<<<< HEAD
             # =======
             # >>>>>>> ë¶€ë¶„ì„ í™•ì¸í•˜ê³  ìˆ˜ì •

             # í•´ê²° í›„ ìŠ¤í…Œì´ì§•
             git add .
             git commit -m "Resolve merge conflicts"
             git push origin ${SYNC_BRANCH}
             \`\`\`

          3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í™•ì¸ (í•„ìš”í•œ ê²½ìš°)

          4. ì´ PR ìŠ¹ì¸ ë° ë¨¸ì§€

          ---

          _ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤._
          EOF
          )

          # GitHub CLIë¡œ PR ìƒì„±
          gh pr create \
            --base develop \
            --head ${SYNC_BRANCH} \
            --title "[Auto] Sync main to develop (from ${SOURCE_BRANCH})" \
            --body "${PR_BODY}" \
            --assignee ${MERGED_BY}

          echo "ğŸ“ Created PR for manual conflict resolution"

      - name: Summary
        if: always()
        run: |
          if [[ "${{ steps.merge.outcome }}" == "success" ]]; then
            echo "### âœ… ìë™ ë™ê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
            echo "Main ë¸Œëœì¹˜ê°€ Developì— ì„±ê³µì ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ ì¶©ëŒ ë°œìƒ - PR ìƒì„±ë¨" >> $GITHUB_STEP_SUMMARY
            echo "ì¶©ëŒì´ ë°œìƒí•˜ì—¬ ë™ê¸°í™” PRì´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "PR: https://github.com/${{ github.repository }}/pulls" >> $GITHUB_STEP_SUMMARY
          fi